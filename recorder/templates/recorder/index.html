<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>üé§ Karaoke Reels</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #000;
  font-family: 'Poppins', sans-serif;
  height: 100vh;
  width: 100vw;
  overflow: hidden;
}

.reel-container,
.final-reel-container {
  width: 100%;
  height: 100%;
  position: absolute;
  background: #111;
  overflow: hidden;
}

#status {
  position: absolute;
  top: 20px;
  width: 100%;
  text-align: center;
  font-size: 14px;
  color: #ccc;
  z-index: 20;
  text-shadow: 1px 1px 6px rgba(0,0,0,0.9);
}

.reel-bg {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 85vh;
  object-fit: contain;
  object-position: top;
}

.lyrics {
  position: absolute;
  bottom: 25%;
  width: 100%;
  text-align: center;
  font-size: 2vw;
  font-weight: bold;
  color: white;
  text-shadow: 2px 2px 10px black;
}

.controls {
  position: absolute;
  bottom: 20%;
  width: 100%;
  text-align: center;
  z-index: 30;
}

button {
  background: linear-gradient(135deg, #ff0066, #ff66cc);
  border: none;
  color: white;
  padding: 8px 20px;
  border-radius: 25px;
  font-size: 13px;
  margin: 4px;
  box-shadow: 0px 3px 15px rgba(255,0,128,0.4);
  cursor: pointer;
}

button:active {
  transform: scale(0.95);
}

.final-output {
  position: fixed;
  width: 100vw;
  height: 100vh;
  top: 0; left: 0;
  background: rgba(0,0,0,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}
</style>
</head>

<body>

<!-- FULL SCREEN UI -->
<div class="reel-container" id="reelContainer">
    <img class="reel-bg" id="mainBg" src="https://karaoke-project-22.onrender.com/media/default_lyrics_bg.jpg">

    <!-- LOGO -->
    <img id="logoImg" src="https://karaoke-project-22.onrender.com/media/logo/branks3_logo.png" 
         style="position:absolute; top:20px; left:20px; width:60px; z-index:50; opacity:0.6;">

    <div id="status"></div>

    <!-- Audio Files -->
    <audio id="originalAudio" src="https://karaoke-project-22.onrender.com/media/original_song1.mp3"></audio>
    <audio id="accompaniment" src="https://karaoke-project-22.onrender.com/media/accompaniment1.mp3"></audio>

    <div class="controls">
      <button id="playBtn">‚ñ∂Ô∏è Play</button>
      <button id="recordBtn">üéôÔ∏è Record</button>
      <button id="stopBtn" style="display:none;">‚èπÔ∏è Stop</button>
    </div>
</div>

<!-- FINAL OUTPUT -->
<div class="final-output" id="finalOutputDiv">
  <div class="final-reel-container">
    <img class="reel-bg" id="finalBg">
    <div id="status"></div>
    <div class="lyrics" id="finalLyrics"></div>
    <div class="controls">
      <button id="playRecordingBtn">‚ñ∂Ô∏è Play Recording</button>
      <a id="downloadRecordingBtn" href="#" download>
        <button>‚¨áÔ∏è Download</button>
      </a>
    </div>
  </div>
</div>

<script>
let mediaRecorder;
let recordedChunks = [];
let currentSongId = 1; // Replace with your song ID if dynamic

const playBtn = document.getElementById("playBtn");
const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const status = document.getElementById("status");

const originalAudio = document.getElementById("originalAudio");
const accompanimentAudio = document.getElementById("accompaniment");

const finalDiv = document.getElementById("finalOutputDiv");
const mainBg = document.getElementById("mainBg");
const finalBg = document.getElementById("finalBg");
const finalLyrics = document.getElementById("finalLyrics");

const playRecordingBtn = document.getElementById("playRecordingBtn");
const downloadRecordingBtn = document.getElementById("downloadRecordingBtn");

let playRecordingAudio = null;
let isPlayingRecording = false;

async function safePlay(audio) {
    try { await audio.play(); }
    catch (e) { console.log("Autoplay blocked:", e); }
}

playBtn.onclick = async () => {
    originalAudio.currentTime = 0;
    await safePlay(originalAudio);
    status.innerText = "üéµ Playing song...";
};

recordBtn.onclick = async () => {
    recordedChunks = [];
    let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
        const blob = new Blob(recordedChunks, { type: "audio/webm" });
        const form = new FormData();
        form.append("recording", blob, "recording.webm");

        status.innerText = "‚è≥ Processing‚Ä¶";

        const resp = await fetch(`https://karaoke-project-22.onrender.com/upload_recording/${currentSongId}/`, {
            method: "POST",
            body: form
        });

        const data = await resp.json();

        finalBg.src = mainBg.src;
        finalLyrics.innerText = ""; // Optional: add lyrics if available
        finalDiv.style.display = "flex";

        downloadRecordingBtn.href = data.final_url;

        playRecordingBtn.onclick = () => {
            if (!isPlayingRecording) {
                playRecordingAudio = new Audio(data.final_url);
                playRecordingAudio.play();
                isPlayingRecording = true;
                playRecordingBtn.innerText = "‚èπÔ∏è Cancel";

                playRecordingAudio.onended = () => {
                    isPlayingRecording = false;
                    playRecordingBtn.innerText = "‚ñ∂Ô∏è Play Recording";
                };
            } else {
                playRecordingAudio.pause();
                playRecordingAudio.currentTime = 0;
                isPlayingRecording = false;
                playRecordingBtn.innerText = "‚ñ∂Ô∏è Play Recording";
            }
        };
    };

    mediaRecorder.start();

    originalAudio.currentTime = 0;
    accompanimentAudio.currentTime = 0;

    await safePlay(originalAudio);
    await safePlay(accompanimentAudio);

    playBtn.style.display = "none";
    recordBtn.style.display = "none";
    stopBtn.style.display = "inline-block";

    status.innerText = "üéôÔ∏è Recording...";
};

stopBtn.onclick = () => {
    try { mediaRecorder.stop(); } catch(e){}
    originalAudio.pause();
    accompanimentAudio.pause();
    status.innerText = "‚èπÔ∏è Recording stopped. Processing‚Ä¶";
    stopBtn.style.display = "none";
};
</script>

</body>
</html>
