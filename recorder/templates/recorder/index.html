<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>üé§ Karaoke Reels</title>

<style>
/* RESET */
* { margin: 0; padding: 0; box-sizing: border-box; }

/* BODY ‚Üí Fullscreen */
body {
  background: #000;
  font-family: 'Poppins', sans-serif;
  height: 100vh;
  width: 100vw;
  overflow: hidden;
}

/* ================================
   üî• FULL SCREEN RESPONSIVE LAYOUT
   ================================ */
.responsive-wrapper {
  width: 100vw;
  min-height: 100vh;
  height: auto;
  overflow: visible;
  position: relative;
}

/* MAIN & FINAL SCREEN */
.reel-container,
.final-reel-container {
  width: 100%;
  height: 100%;
  position: absolute;
  background: #111;
  overflow: hidden;
}

/* STATUS TEXT ‚Äì (HEADPHONE MESSAGE REMOVED) */
#status {
  position: absolute;
  top: 20px;
  width: 100%;
  text-align: center;
  font-size: 14px;
  color: #ccc;
  z-index: 20;
  text-shadow: 1px 1px 6px rgba(0,0,0,0.9);
}

/* BACKGROUND IMAGE */
.reel-bg {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 85vh;
  object-fit: contain;
  object-position: top;
}

/* LYRICS */
.lyrics {
  position: absolute;
  bottom: 25%;
  width: 100%;
  text-align: center;
  font-size: 2vw;
  font-weight: bold;
  color: white;
  text-shadow: 2px 2px 10px black;
}

/* BUTTON AREA */
.controls {
  position: absolute;
  bottom: 20%;
  width: 100%;
  text-align: center;
  z-index: 30;
}

/* BUTTONS (SMALL SIZE) */
button {
  background: linear-gradient(135deg, #ff0066, #ff66cc);
  border: none;
  color: white;
  padding: 8px 20px;   /* üî• Smaller padding */
  border-radius: 25px; /* Slightly smaller rounded */
  font-size: 13px;     /* üî• Smaller text */
  margin: 4px;
  box-shadow: 0px 3px 15px rgba(255,0,128,0.4);
  cursor: pointer;
}

button:active {
  transform: scale(0.95);
}

/* FINAL OUTPUT FULLSCREEN */
.final-output {
  position: fixed;
  width: 100vw;
  height: 100vh;
  top: 0; left: 0;
  background: rgba(0,0,0,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}
</style>
</head>

<body>

{% with s=songs.0 %}

<!-- FULL SCREEN UI -->
<div class="reel-container" id="reelContainer">
    {% if s.lyrics_image %}
      <img class="reel-bg" id="mainBg" src="{{ s.lyrics_image.url }}">
    {% else %}
      <img class="reel-bg" id="mainBg" src="/static/default_lyrics_bg.jpg">
    {% endif %}

    <!-- üîπ LOGO TOP LEFT -->
    <img id="logoImg" src="/media/logo/branks3_logo.png" 
         style="position:absolute; top:20px; left:20px; width:60px; z-index:50; opacity:0.6;">

    <div id="status"></div>

    <audio id="originalAudio" src="{{ s.original_file.url }}"></audio>
    <audio id="accompaniment" src="{{ s.accompaniment_file.url }}"></audio>

    <div class="controls">
      <button id="playBtn">‚ñ∂ Play</button>
      <button id="recordBtn">üéô Record</button>
      <button id="stopBtn" style="display:none;">‚èπ Stop</button>
    </div>
</div>

</div>

{% endwith %}

<!-- FINAL OUTPUT -->
<div class="final-output" id="finalOutputDiv">
  <div class="final-reel-container">
    <img class="reel-bg" id="finalBg">

    <!-- üî• HEADPHONE TEXT REMOVED -->
    <div id="status"></div>

    <div class="lyrics" id="finalLyrics"></div>

    <div class="controls">
      <button id="playRecordingBtn">‚ñ∂ Play Recording</button>
      <a id="downloadRecordingBtn" href="#" download>
        <button>‚¨á Download</button>
      </a>
    </div>
  </div>
</div>

<script>
let mediaRecorder;
let recordedChunks = [];
let currentSongId = "{{ songs.0.id }}";

const playBtn = document.getElementById("playBtn");
const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const status = document.getElementById("status");

const originalAudio = document.getElementById("originalAudio");
const accompanimentAudio = document.getElementById("accompaniment");

const finalDiv = document.getElementById("finalOutputDiv");
const mainBg = document.getElementById("mainBg");
const mainLyrics = document.getElementById("mainLyrics");
const finalBg = document.getElementById("finalBg");
const finalLyrics = document.getElementById("finalLyrics");

const playRecordingBtn = document.getElementById("playRecordingBtn");
const downloadRecordingBtn = document.getElementById("downloadRecordingBtn");

let playRecordingAudio = null;
let isPlayingRecording = false;

async function safePlay(audio) {
    try { await audio.play(); }
    catch (e) { console.log("Autoplay blocked:", e); }
}

playBtn.onclick = async () => {
    originalAudio.currentTime = 0;
    await safePlay(originalAudio);
    status.innerText = "üéµ Playing song...";
};

recordBtn.onclick = async () => {
    recordedChunks = [];

    let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
        const blob = new Blob(recordedChunks, { type: "audio/webm" });
        const form = new FormData();
        form.append("recording", blob, "recording.webm");

        status.innerText = "‚è≥ Processing‚Ä¶";

        const resp = await fetch(/upload_recording/${currentSongId}/, {
            method: "POST",
            body: form
        });

        const data = await resp.json();

        finalBg.src = mainBg.src;
        finalLyrics.innerText = mainLyrics?.innerText || "";

        finalDiv.style.display = "flex";

        downloadRecordingBtn.href = data.final_url;

        playRecordingBtn.onclick = () => {
            if (!isPlayingRecording) {
                playRecordingAudio = new Audio(data.final_url);
                playRecordingAudio.play();
                isPlayingRecording = true;
                playRecordingBtn.innerText = "‚èπ Cancel";

                playRecordingAudio.onended = () => {
                    isPlayingRecording = false;
                    playRecordingBtn.innerText = "‚ñ∂ Play Recording";
                };
            } else {
                playRecordingAudio.pause();
                playRecordingAudio.currentTime = 0;
                isPlayingRecording = false;
                playRecordingBtn.innerText = "‚ñ∂ Play Recording";
            }
        };
    };

    await new Promise(res => setTimeout(res, 150));

    mediaRecorder.start();

    originalAudio.currentTime = 0;
    accompanimentAudio.currentTime = 0;

    await safePlay(originalAudio);
    await safePlay(accompanimentAudio);

    playBtn.style.display = "none";
    recordBtn.style.display = "none";
    stopBtn.style.display = "inline-block";

    status.innerText = "üéô Recording...";
};

stopBtn.onclick = () => {
    try { mediaRecorder.stop(); } catch(e){}

    originalAudio.pause();
    accompanimentAudio.pause();

    status.innerText = "‚èπ Recording stopped. Processing‚Ä¶";

    stopBtn.style.display = "none";
};
</script>

</body>
</html>
